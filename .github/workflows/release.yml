name: Release

on:
  release:
    types:
      - created
      - published
      - prereleased

jobs:
  build-and-publish:
    name: Build and publish plugin
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PLUGIN_SLUG: aimentor-elementor
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: none

      - name: Validate PHP syntax
        run: |
          set -euo pipefail
          find . \
            -path './.git' -prune -o \
            -path './.github' -prune -o \
            -path './build' -prune -o \
            -name '*.php' -print0 | xargs -0 -n1 php -l

      - name: Validate release metadata
        # Ensure the release tag matches plugin headers and manifests before creating artifacts.
        run: |
          set -euo pipefail

          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          if [ -z "$VERSION" ]; then
            VERSION="$TAG"
          fi

          PHP_FILE='aimentor-elementor.php'

          HEADER_VERSION=$(php -r 'if(!preg_match("/^\\s*\\*\\s*Version:\\s*(.+)$/m", file_get_contents($argv[1]), $m)){fwrite(STDERR, "Unable to locate plugin header version in {$argv[1]}".PHP_EOL); exit(1);} echo trim($m[1]);' "$PHP_FILE")
          CONSTANT_VERSION=$(php -r 'if(!preg_match("/define\\(\\s*[\"\']AIMENTOR_PLUGIN_VERSION[\"\']\\s*,\\s*[\"\']([^\"\']+)[\"\']\\s*\\)/", file_get_contents($argv[1]), $m)){fwrite(STDERR, "Unable to locate AIMENTOR_PLUGIN_VERSION constant in {$argv[1]}".PHP_EOL); exit(1);} echo $m[1];' "$PHP_FILE")
          README_VERSION=$(php -r 'if(!preg_match("/^Stable tag:\\s*(.+)$/m", file_get_contents($argv[1]), $m)){fwrite(STDERR, "Unable to locate Stable tag in {$argv[1]}".PHP_EOL); exit(1);} echo trim($m[1]);' readme.txt)
          MANIFEST_VERSION=$(php -r '$path=$argv[1]; $json=json_decode(file_get_contents($path), true); if(!is_array($json) || !isset($json["version"]) || $json["version"] === ""){fwrite(STDERR, "Unable to parse version from {$path}".PHP_EOL); exit(1);} echo $json["version"];' manifests/aimentor-plugin-info.json)

          MISMATCH=0

          if [ "$VERSION" != "$HEADER_VERSION" ]; then
            echo "::error ::Release tag version $VERSION does not match plugin header version $HEADER_VERSION" >&2
            MISMATCH=1
          fi

          if [ "$VERSION" != "$CONSTANT_VERSION" ]; then
            echo "::error ::Release tag version $VERSION does not match AIMENTOR_PLUGIN_VERSION constant $CONSTANT_VERSION" >&2
            MISMATCH=1
          fi

          if [ "$VERSION" != "$README_VERSION" ]; then
            echo "::error ::Release tag version $VERSION does not match readme.txt stable tag $README_VERSION" >&2
            MISMATCH=1
          fi

          if [ "$VERSION" != "$MANIFEST_VERSION" ]; then
            echo "::error ::Release tag version $VERSION does not match manifests/aimentor-plugin-info.json version $MANIFEST_VERSION" >&2
            MISMATCH=1
          fi

          if [ "$MISMATCH" -ne 0 ]; then
            echo "Version mismatch detected. Update plugin metadata before publishing a release." >&2
            exit 1
          fi

      - name: Build plugin archive
        id: package
        run: |
          set -euo pipefail

          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          if [ -z "$VERSION" ]; then
            VERSION="$TAG"
          fi

          ZIP_NAME="${PLUGIN_SLUG}.zip"
          BUILD_DIR="build/${PLUGIN_SLUG}"

          rm -rf build
          mkdir -p "$BUILD_DIR"

          rsync -av \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'build/' \
            --exclude 'docs/' \
            --exclude 'downloads/' \
            --exclude 'manifests/' \
            --exclude '*.zip' \
            --exclude '.gitignore' \
            ./ "$BUILD_DIR"/

          pushd build >/dev/null
          zip -r "../${ZIP_NAME}" "${PLUGIN_SLUG}"
          popd >/dev/null

          SHA256=$(sha256sum "${ZIP_NAME}" | cut -d' ' -f1)

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          echo "zip_path=$PWD/${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

      - name: Verify archive structure
        run: |
          set -euo pipefail

          ZIP_PATH='${{ steps.package.outputs.zip_path }}'
          SLUG='${{ env.PLUGIN_SLUG }}'

          if [ ! -f "$ZIP_PATH" ]; then
            echo "::error ::Expected archive $ZIP_PATH not found" >&2
            exit 1
          fi

          mapfile -t ENTRIES < <(zipinfo -1 "$ZIP_PATH")

          if [ "${#ENTRIES[@]}" -eq 0 ]; then
            echo "::error ::Archive $ZIP_PATH is empty" >&2
            exit 1
          fi

          BAD=0
          for ENTRY in "${ENTRIES[@]}"; do
            # Extract top-level directory name (characters before the first '/')
            TOP_LEVEL="${ENTRY%%/*}"

            if [ -z "$TOP_LEVEL" ] || [ "$TOP_LEVEL" != "$SLUG" ]; then
              echo "::error ::Archive entry '$ENTRY' is not under ${SLUG}/" >&2
              BAD=1
            fi
          done

          if [ "$BAD" -ne 0 ]; then
            echo "::error ::Archive contains entries outside of ${SLUG}/. Rebuild the package before retrying." >&2
            exit 1
          fi

      - name: Attach archive to release
        if: ${{ github.event.action == 'created' }}
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip manifest update for draft or pre-release
        if: ${{ github.event.release.draft || github.event.release.prerelease }}
        run: |
          echo "Release is marked as draft or pre-release; manifest refresh will be deferred until publication."

      - name: Update manifest on gh-pages
        if: ${{ steps.package.outputs.zip_path != '' && !github.event.release.draft && !github.event.release.prerelease }}
        run: |
          set -euo pipefail

          TAG='${{ steps.package.outputs.tag }}'
          VERSION='${{ steps.package.outputs.version }}'
          ZIP_NAME='${{ steps.package.outputs.zip_name }}'
          ZIP_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${ZIP_NAME}"
          SHA256='${{ steps.package.outputs.sha256 }}'
          PUBLISHED='${{ github.event.release.published_at }}'

          export TAG VERSION ZIP_NAME ZIP_URL SHA256 PUBLISHED

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin gh-pages || true

          WORKTREE_PATH="gh-pages-worktree"

          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git branch --force gh-pages origin/gh-pages
            git worktree add "$WORKTREE_PATH" gh-pages
          else
            git worktree add -b gh-pages "$WORKTREE_PATH"
          fi

          pushd "$WORKTREE_PATH" >/dev/null
          mkdir -p manifests

          php -r '$data = [
            "name" => "AiMentor Elementor",
            "slug" => "aimentor-elementor",
            "version" => getenv("VERSION"),
            "download_url" => getenv("ZIP_URL"),
            "released_at" => getenv("PUBLISHED"),
            "checksum" => [
              "algorithm" => "sha256",
              "hash" => getenv("SHA256")
            ],
            "source" => "https://github.com/" . getenv("GITHUB_REPOSITORY")
          ];

          $json = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
          if ($json === false) {
            fwrite(STDERR, "Failed to encode manifest JSON" . PHP_EOL);
            exit(1);
          }

          file_put_contents("manifests/aimentor-plugin-info.json", $json . PHP_EOL);'

          if git diff --quiet -- manifests/aimentor-plugin-info.json; then
            echo "Manifest already up to date"
          else
            git add manifests/aimentor-plugin-info.json
            git commit -m "Update manifest for ${TAG}"
            git push origin HEAD:gh-pages
          fi
          popd >/dev/null

          git worktree remove "$WORKTREE_PATH"
          git branch -D gh-pages || true
